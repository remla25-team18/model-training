name: ML Testing

on: push

jobs:
    test:
        runs-on: ubuntu-latest
        
        # Prevent running tests on pushes from GitHub Actions itself to avoid infinite loops
        if: github.actor != 'github-actions' 
        steps:
            - name: Checkout code
              uses: actions/checkout@v4
              with:
                token: ${{ secrets.GH_TOKEN }}
            
            - name: Set up Python 3.11
              uses: actions/setup-python@v4
              with:
                python-version: '3.11'

            - name: Install dependencies
              run: |
                pip install -e .[dev]

            # Saving as XML and txt to have both a human-readable and machine-readable format available
            - name: Run tests with pytest and coverage
              run: |
                pytest -v --cov=src --cov-report=xml --cov-report=term-missing tests/ | tee pytest-coverage.txt
                cat pytest-coverage.txt
                coverage-badge -o coverage.svg -f

            - name: Calculate ML test score
              id: score
              run: |
                score=$(python tests/calculate_ML_test_score.py)
                echo "score=$score" >> $GITHUB_OUTPUT

            - name: Determine badge color
              id: color
              run: |
                score=${{ steps.score.outputs.score }}
                if [ "$score" -ge 3 ]; then
                  color="brightgreen"
                elif [ "$score" -ge 2 ]; then
                  color="yellow"
                else
                  color="red"
                fi
                echo "color=$color" >> $GITHUB_OUTPUT

            - name: Generate ML test score badge
              uses: emibcn/badge-action@v1
              with:
                label: 'ML Test Score'
                status: ${{ steps.score.outputs.score }}
                color: ${{ steps.color.outputs.color }}
                path: badge-ML-test-score.svg
            
            - name: Commit changes
              run: |
                git config user.name "github-actions"
                git config user.email "github-actions@github.com"
                git add pytest-coverage.txt coverage.svg badge-ML-test-score.svg
                if git diff --cached --quiet; then
                  echo "No changes to commit"
                else
                  git commit -m "Update coverage and ML test score badges [skip ci]"
                  git push
                fi
